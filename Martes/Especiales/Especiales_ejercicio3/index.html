<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Ejercicio 3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body { min-height: 100vh; font-family: inherit; }

  .contenedor-principal {
    background-color: #b8d4e3;
    min-height: 100vh;
    padding: 20px;
    transition: all 0.2s ease;
  }

  .contenedor_principal_desactivado {
    pointer-events: none;
    user-select: none;
    opacity: 0.5;
  }

  h1 { font-size: 24px; font-weight: bold; margin-bottom: 16px; color: #000; }

  .btn-modal {
    display: inline-block;
    background-color: #e0e0e0;
    border: 2px solid #666;
    padding: 8px 16px;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
    -webkit-appearance: none;
    appearance: none;
    transition: background-color 0.12s ease;
  }
  .btn-modal:focus { outline: none; }
  .btn-modal::-moz-focus-inner { border: 0; padding: 0; }

  .ayudas { margin-top: 24px; font-size: 14px; color: #000; }
  .ayudas h3 { font-weight: bold; margin-bottom: 8px; }
  .ayudas p { margin-bottom: 4px; }

  .modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(255,255,255,0.5);
    z-index: 40; display: none;
  }

  .modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 50; display: none; align-items: center; justify-content: center; padding: 16px;
  }

  .modal-content {
    background: white; width: 100%; max-width: 1100px; max-height: 100%; overflow-y: auto;
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
  }

  .modal-header { background-color: #9ca3af; padding: 12px 24px; display:flex; justify-content:space-between; align-items:center; }
  .modal-title { font-size: 18px; font-weight: bold; color: #000; }
  .btn-close { background: none; border: none; color: #dc2626; font-size: 24px; font-weight: bold; cursor: pointer; width: 30px; height: 30px; display:flex; align-items:center; justify-content:center; }
  .btn-close:hover { color: #991b1b; }

  .modal-body {
    background: #f8f8d6;
    padding: 20px;
  }

  .show { display: flex !important; }
  .show-block { display: block !important; }

  .formulario-container {
    max-width: 1000px;
    margin: 0 auto;
  }

  .formulario-container h2 {
    margin-bottom: 20px;
    font-weight: bold;
    text-align: center;
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px 40px;
    margin-bottom: 20px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  .form-group label {
    font-weight: bold;
    margin-bottom: 5px;
  }

  .form-group input,
  .form-group select {
    padding: 6px;
    border: 1px solid #aaa;
    border-radius: 2px;
  }

  .btn-enviar {
    grid-column: span 2;
    padding: 12px;
    background: #eee;
    border: 1px solid #aaa;
    cursor: pointer;
    text-align: center;
    font-weight: bold;
  }

  .btn-enviar:hover {
    background: #ddd;
  }

  .form-footer {
    text-align: center;
    margin-top: 15px;
    font-weight: bold;
  }

  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
    .btn-enviar {
      grid-column: span 1;
    }
  }
</style>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <div id="contenedorPrincipal" class="contenedor-principal">
    <h1>Esto es el div contenedor</h1>
    <button id="btnAbrirModal" class="btn-modal">Abre DIV modal</button>

    <div class="ayudas">
      <h3>Ayudas para el ejercicio</h3>
      <p>El div contenedor deberá ser desactivado cuando se active la ventana modal</p>
      <p>Desactivar el contenedor podría ser darle transparencia y deshabilitar todos sus botones.</p>
      <p>Desactivado:</p>
      <p>pointer-events: none</p>
      <p>opacity: 0.3</p>
      <p>Activado:</p>
      <p>pointer-events: auto</p>
      <p>opacity: 1</p>
    </div>
  </div>

  <div id="modalOverlay" class="modal-overlay"></div>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2 class="modal-title">Encabezado modal</h2>
        <button id="btnCerrarModal" class="btn-close" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body" id="modalBody">
      </div>
    </div>
  </div>

<script>
$(function () {
  const $contenedor = $('#contenedorPrincipal');
  const $modal = $('#modal');
  const $overlay = $('#modalOverlay');
  const $modalBody = $('#modalBody');
  const $modalTitle = $('.modal-title');
  let movimientosData = [];
  let tiposMovimiento = [];

  function cargarDatos() {
    return Promise.all([
      $.getJSON('TablaPadre.json'),
      $.getJSON('TablaHijo.json')
    ]).then(function([padreData, hijoData]) {
      movimientosData = padreData.MovimientosDeStock;
      tiposMovimiento = hijoData.TipoDeMov;
    }).catch(function(error) {
      console.error('Error cargando datos:', error);
      $modalBody.html('<p style="color:red">Error cargando datos de los archivos JSON</p>');
    });
  }

  function crearFormularioModal() {
    const formularioHTML = `
      <div class="formulario-container">
        
        <form id="formularioModal" method="get" action="respuesta.html">
          <div class="form-grid">
            <div class="form-group">
              <label for="CodArticulo">Código de Artículo:</label>
              <input type="text" id="CodArticulo" name="CodArticulo" required>
            </div>

            <div class="form-group">
              <label for="tipoMov">Tipo de Movimiento:</label>
              <select id="tipoMov" name="tipoMov" required>
                <option value="">Seleccione un tipo de movimiento</option>
              </select>
            </div>

            <div class="form-group">
              <label for="descripcion">Descripción:</label>
              <input type="text" id="descripcion" name="descripcion" required>
            </div>

            <div class="form-group">
              <label for="fechaMov">Fecha Movimiento:</label>
              <input type="date" id="fechaMov" name="fechaMov" required>
            </div>

            <div class="form-group">
              <label for="cantidad">Cantidad:</label>
              <input type="number" id="cantidad" name="cantidad" value="1" min="1" required>
            </div>

            <div class="form-group">
              <label for="nroLote">Número de Lote:</label>
              <input type="text" id="nroLote" name="nroLote" placeholder="Ej: L-01" required>
            </div>

            <div class="form-group">
              <label for="unidadMedida">Unidad de Medida:</label>
              <input type="text" id="unidadMedida" name="unidadMedida" placeholder="Ej: CAJ, U, M, KG" required>
            </div>

            <div class="form-group">
              <label for="fotoArticulo">Foto del Artículo:</label>
              <input type="file" id="fotoArticulo" name="fotoArticulo" accept="image/*">
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-enviar">ENVIAR FORMULARIO</button>
          </div>
        </form>
      </div>
    `;

    $modalBody.html(formularioHTML);
    poblarSelects();
    configurarEventos();
  }

  function poblarSelects() {
    const $selectMovimiento = $('#seleccionMovimiento');
    $selectMovimiento.empty().append('<option value="">Seleccionar movimiento existente...</option>');
    
    movimientosData.forEach(function(movimiento, index) {
      const tipoMov = tiposMovimiento.find(t => t.IdMov === movimiento.IdMov);
      const descripcionTipo = tipoMov ? tipoMov.Descripcion : 'Tipo desconocido';
      $selectMovimiento.append(`<option value="${index}">${movimiento.CodArticulo} - ${movimiento.Descripcion} (${descripcionTipo})</option>`);
    });

    const $selectTipo = $('#tipoMov');
    $selectTipo.empty().append('<option value="">Seleccione un tipo de movimiento</option>');
    
    tiposMovimiento.forEach(function(tipo) {
      $selectTipo.append(`<option value="${tipo.Codigo}">${tipo.Codigo} - ${tipo.Descripcion}</option>`);
    });
  }

  function configurarEventos() {
    $('#btnCargarDatos').on('click', function() {
      const indice = $('#seleccionMovimiento').val();
      if (indice !== '') {
        cargarDatosMovimiento(parseInt(indice));
      }
    });

    $('#formularioModal').on('submit', function(e) {
      e.preventDefault();
      enviarFormulario();
    });
  }

  function cargarDatosMovimiento(indice) {
    const movimiento = movimientosData[indice];
    if (movimiento) {
      $('#CodArticulo').val(movimiento.CodArticulo);
      $('#descripcion').val(movimiento.Descripcion);
      $('#fechaMov').val(movimiento.FechaMovimiento);
      $('#cantidad').val(movimiento.Cantidad);
      $('#nroLote').val(movimiento.NroDeLote);
      $('#unidadMedida').val(movimiento.UnidadMedida);
      
      const tipoMov = tiposMovimiento.find(t => t.IdMov === movimiento.IdMov);
      if (tipoMov) {
        $('#tipoMov').val(tipoMov.Codigo);
      }
    }
  }

  function enviarFormulario() {
    const formData = new FormData($('#formularioModal')[0]);
    const params = new URLSearchParams();
    
    for (let [key, value] of formData.entries()) {
      if (key !== 'fotoArticulo') {
        params.append(key, value);
      }
    }
    
    const fileInput = $('#fotoArticulo')[0];
    if (fileInput.files.length > 0) {
      params.append('fotoArticulo', fileInput.files[0].name);
    } else {
      params.append('fotoArticulo', 'No seleccionado');
    }

    window.location.href = 'respuesta.html?' + params.toString();
  }

  function abrirModal() {
    $modalTitle.text('Formulario de Movimientos de Stock');
      $contenedor.addClass('contenedor_principal_desactivado');
      $modal.addClass('show').attr('aria-hidden', 'false');
      $overlay.addClass('show-block');
    
    setTimeout(function() {
      $('#CodArticulo').focus();
    }, 100);
  }

  function cerrarModal() {
    $contenedor.removeClass('contenedor_principal_desactivado');
    $modal.removeClass('show').attr('aria-hidden', 'true');
    $overlay.removeClass('show-block');
  }

  cargarDatos().then(function() {
    crearFormularioModal();
  });

  $('#btnAbrirModal').on('click', abrirModal);
  $('#btnCerrarModal, #modalOverlay').on('click', cerrarModal);

  $(document).on('keydown', function(e) {
    if (e.key === 'Escape' && $modal.hasClass('show')) {
      cerrarModal();
    }
  });
});
</script>
</body>
</html>